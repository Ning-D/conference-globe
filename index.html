<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Interactive Conference Globe ğŸŒ</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      background: black;
    }

    /* ğŸª åœ°çƒå±‚ */
    #globeViz {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      z-index: 1;
      transition: opacity 1.5s ease-in-out;
    }

    /* ğŸŒ† åŸå¸‚èƒŒæ™¯å±‚ï¼ˆå¯è§ä½†ä¸æŒ¡äº¤äº’ï¼‰ */
    #cityBackground {
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-size: cover;
      background-position: center;
      opacity: 0;
      transition: opacity 1.5s ease-in-out;
      z-index: 0;
      pointer-events: none;   /* âœ… é¼ æ ‡äº‹ä»¶é€ä¼ åˆ°åœ°çƒ */
      will-change: opacity;   /* âœ… é˜²æ­¢æ–°åˆæˆå±‚å½±å“äº¤äº’ */
    }

    /* ğŸ“‹ ä¿¡æ¯é¢æ¿ */
    #infoPanel {
      position: absolute;
      top: 60px; right: 40px;
      width: 320px; padding: 15px;
      background: rgba(20, 20, 20, 0.7);
      color: white;
      border-radius: 15px;
      backdrop-filter: blur(8px);
      font-family: 'Segoe UI', sans-serif;
      display: none;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 10;
    }
    #infoPanel img, #infoPanel video {
      width: 100%;
      border-radius: 10px;
      margin-top: 10px;
    }

    /* ğŸ”™ è¿”å›æŒ‰é’® */
    #backButton {
      position: absolute;
      bottom: 40px; right: 40px;
      padding: 10px 20px;
      border: none; border-radius: 10px;
      background: rgba(255,255,255,0.15);
      color: white;
      font-size: 16px;
      cursor: pointer;
      backdrop-filter: blur(6px);
      display: none;
      transition: background 0.3s;
      z-index: 10;
    }
    #backButton:hover { background: rgba(255,255,255,0.35); }
  </style>
</head>
<body>
  <div id="cityBackground"></div>
  <div id="globeViz"></div>

  <div id="infoPanel">
    <h2 id="title"></h2>
    <p id="desc"></p>
    <img id="photo" src="">
    <video id="video" controls></video>
  </div>

  <button id="backButton">ğŸŒ è¿”å›å…¨çƒè§†è§’</button>

  <!-- Libraries -->
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/globe.gl@2.32.3/dist/globe.gl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  const xlsxUrl = 'https://raw.githubusercontent.com/Ning-D/conference-globe/main/conference_points.xlsx';
  const cityBackgrounds = {
    "Tokyo": "https://upload.wikimedia.org/wikipedia/commons/1/12/Tokyo_Tower_and_around_Skyscrapers.jpg",
    "Paris": "https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg",
    "New York": "https://upload.wikimedia.org/wikipedia/commons/a/a1/Manhattan_skyline_from_Jersey_City_November_2014_panorama_3.jpg",
    "Beijing": "https://upload.wikimedia.org/wikipedia/commons/d/d4/Beijing_skyline.jpg"
  };

  fetch(xlsxUrl)
    .then(res => res.arrayBuffer())
    .then(ab => {
      const workbook = XLSX.read(ab, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const data = XLSX.utils.sheet_to_json(worksheet);

      const globe = Globe()(document.getElementById('globeViz'))
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
        .pointAltitude(0.03)
        .pointColor(() => 'rgba(255,180,80,0.9)')
        .pointRadius(0.6)
        .showAtmosphere(true)
        .atmosphereColor('#00ffff')
        .atmosphereAltitude(0.2)
        .pointsData(data);

      const initialView = { lat: 20, lng: 120, altitude: 2 };
      globe.pointOfView(initialView);
      const controls = globe.controls();
      controls.autoRotate = true;
      controls.autoRotateSpeed = 0.5;

      const infoPanel = document.getElementById('infoPanel');
      const backButton = document.getElementById('backButton');
      const cityBg = document.getElementById('cityBackground');

      globe.onPointClick(point => {
        infoPanel.style.display = "block";
        backButton.style.display = "block";
        controls.autoRotate = false;

        document.getElementById("title").innerText = point.name || "Unnamed";
        document.getElementById("desc").innerText = point.desc || "";
        document.getElementById("photo").src = point.photo || "";
        document.getElementById("video").src = point.video || "";

        // é£åˆ°è¯¥åŸå¸‚
        globe.pointOfView({ lat: point.lat, lng: point.lng, altitude: 1.5 }, 2000);

        // åŒ¹é…åŸå¸‚èƒŒæ™¯
        const matchedCity = Object.keys(cityBackgrounds).find(city =>
          (point.name || "").toLowerCase().includes(city.toLowerCase())
        );

        if (matchedCity) {
          setTimeout(() => {
            cityBg.style.backgroundImage = `url(${cityBackgrounds[matchedCity]})`;
            cityBg.style.opacity = 1;
          }, 2200);
        }

        // ç¨å¾®æ—‹è½¬ä¸€ç‚¹è§’åº¦ï¼Œæ¨¡æ‹Ÿ"é£å…¥è§†è§’"
        setTimeout(() => {
          globe.pointOfView({ lat: point.lat + 0.5, lng: point.lng + 0.8, altitude: 0.35 }, 2500);
        }, 2200);

        // 4ç§’åæ¢å¤æ‹–åŠ¨åŠŸèƒ½
        setTimeout(() => {
          controls.enabled = true;
        }, 4000);
      });

      // è¿”å›å…¨çƒè§†è§’
      function resetToGlobal() {
        infoPanel.style.display = "none";
        backButton.style.display = "none";
        cityBg.style.opacity = 0;
        globe.pointOfView(initialView, 2000);
        controls.autoRotate = true;
        controls.enabled = true; // âœ… æ¢å¤æ—‹è½¬ä¸äº¤äº’
      }

      backButton.addEventListener('click', resetToGlobal);
      document.addEventListener('keydown', e => { if (e.key === 'Escape') resetToGlobal(); });
      document.addEventListener('click', e => {
        if (!infoPanel.contains(e.target) && e.target !== backButton) resetToGlobal();
      });
    })
    .catch(err => console.error("âŒ è½½å…¥ Excel å¤±è´¥:", err));
  </script>
</body>
</html>
