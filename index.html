<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Free-Rotation Conference Globe 🌏</title>
  <style>
    html, body { margin: 0; overflow: hidden; background: black; }

    #globeViz { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }

    #cityBackground {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background-size: cover; background-position: center;
      opacity: 0; transition: opacity 1.5s ease-in-out;
      z-index: 0;
      pointer-events: none;
    }

    #infoPanel {
      position: absolute; top: 60px; right: 40px; width: 320px; padding: 15px;
      background: rgba(20, 20, 20, 0.7); color: white;
      border-radius: 15px; backdrop-filter: blur(8px);
      font-family: 'Segoe UI', sans-serif;
      display: none; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 10;
    }
    #infoPanel img, #infoPanel video { width: 100%; border-radius: 10px; margin-top: 10px; }

    #backButton {
      position: absolute; bottom: 40px; right: 40px;
      padding: 10px 20px; border: none; border-radius: 10px;
      background: rgba(255,255,255,0.15); color: white;
      font-size: 16px; cursor: pointer;
      backdrop-filter: blur(6px); display: none;
      transition: background 0.3s; z-index: 10;
    }
    #backButton:hover { background: rgba(255,255,255,0.35); }
  </style>
</head>
<body>
  <div id="cityBackground"></div>
  <div id="globeViz"></div>

  <div id="infoPanel">
    <h2 id="title"></h2>
    <p id="desc"></p>
    <img id="photo" src="">
    <video id="video" controls></video>
  </div>

  <button id="backButton">🌍 返回全球视角</button>

  <!-- === 依赖库 === -->
  <script src="https://unpkg.com/three@0.157.0/build/three.min.js"></script>
  <script src="https://unpkg.com/three@0.157.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://unpkg.com/globe.gl@2.32.3/dist/globe.gl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js"></script>

  <script>
  const xlsxUrl = 'https://raw.githubusercontent.com/Ning-D/conference-globe/main/conference_points.xlsx';

  const cityBackgrounds = {
    "Tokyo": "https://upload.wikimedia.org/wikipedia/commons/1/12/Tokyo_Tower_and_around_Skyscrapers.jpg",
    "Paris": "https://upload.wikimedia.org/wikipedia/commons/a/a8/Tour_Eiffel_Wikimedia_Commons.jpg",
    "New York": "https://upload.wikimedia.org/wikipedia/commons/a/a1/Manhattan_skyline_from_Jersey_City_November_2014_panorama_3.jpg",
    "Beijing": "https://upload.wikimedia.org/wikipedia/commons/d/d4/Beijing_skyline.jpg"
  };

  fetch(xlsxUrl)
    .then(res => res.arrayBuffer())
    .then(ab => {
      const workbook = XLSX.read(ab, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const data = XLSX.utils.sheet_to_json(worksheet);

      // === 初始化 Globe.gl ===
      const globe = Globe()(document.getElementById('globeViz'))
        .globeImageUrl('https://unpkg.com/three-globe/example/img/earth-blue-marble.jpg')
        .backgroundImageUrl('https://unpkg.com/three-globe/example/img/night-sky.png')
        .pointAltitude(0.03)
        .pointColor(() => 'rgba(255,180,80,0.9)')
        .pointRadius(0.6)
        .showAtmosphere(true)
        .atmosphereColor('#00ffff')
        .atmosphereAltitude(0.25)
        .pointsData(data);

      // 🌍 初始化视角（渲染一帧确保贴图加载）
      globe.pointOfView({ lat: 0, lng: 0, altitude: 2 });

      setTimeout(() => {
        globe.pauseAnimation(); // 停止内部自动控制

        const renderer = globe.renderer();
        const camera = globe.camera();
        const scene = globe.scene();

        // 禁用默认控制器
        globe.controls().enabled = false;

        // === 自定义 OrbitControls ===
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.rotateSpeed = 0.7;
        controls.zoomSpeed = 0.8;
        controls.enablePan = false;
        controls.minDistance = 200;
        controls.maxDistance = 1000;
        controls.minPolarAngle = 0;
        controls.maxPolarAngle = Math.PI;
        camera.position.set(0, 0, 400);

        const infoPanel = document.getElementById('infoPanel');
        const backButton = document.getElementById('backButton');
        const cityBg = document.getElementById('cityBackground');

        // === 点击城市点 ===
        globe.onPointClick(point => {
          infoPanel.style.display = "block";
          backButton.style.display = "block";

          document.getElementById("title").innerText = point.name || "Unnamed";
          document.getElementById("desc").innerText = point.desc || "";
          document.getElementById("photo").src = point.photo || "";
          document.getElementById("video").src = point.video || "";

          // === 计算飞行目标 ===
          const phi = (90 - point.lat) * Math.PI / 180;
          const theta = (point.lng + 180) * Math.PI / 180;
          const r = 400;
          const target = new THREE.Vector3(
            r * Math.sin(phi) * Math.cos(theta),
            r * Math.cos(phi),
            r * Math.sin(phi) * Math.sin(theta)
          );

          new TWEEN.Tween(camera.position)
            .to({ x: target.x, y: target.y, z: target.z }, 2000)
            .easing(TWEEN.Easing.Quadratic.Out)
            .start();

          const matchedCity = Object.keys(cityBackgrounds).find(city =>
            (point.name || "").toLowerCase().includes(city.toLowerCase())
          );
          if (matchedCity) {
            setTimeout(() => {
              cityBg.style.backgroundImage = `url(${cityBackgrounds[matchedCity]})`;
              cityBg.style.opacity = 1;
            }, 2000);
          }
        });

        // === 返回全球视角 ===
        function resetToGlobal() {
          infoPanel.style.display = "none";
          backButton.style.display = "none";
          cityBg.style.opacity = 0;
          new TWEEN.Tween(camera.position)
            .to({ x: 0, y: 0, z: 400 }, 1500)
            .easing(TWEEN.Easing.Quadratic.Out)
            .start();
        }

        backButton.addEventListener('click', resetToGlobal);
        document.addEventListener('keydown', e => { if (e.key === 'Escape') resetToGlobal(); });

        const globeContainer = document.getElementById('globeViz');

        // === 渲染循环 ===
        function animate() {
          requestAnimationFrame(animate);
          controls.update();
          TWEEN.update();

          // ✅ 保持自适应尺寸（否则会卡住）
          const width = globeContainer.clientWidth;
          const height = globeContainer.clientHeight;
          if (renderer.getSize(new THREE.Vector2()).x !== width) {
            camera.aspect = width / height;
            camera.updateProjectionMatrix();
            renderer.setSize(width, height);
          }

          renderer.render(scene, camera);
        }
        animate();

        // === 窗口尺寸变化时更新 ===
        window.addEventListener('resize', () => {
          const width = globeContainer.clientWidth;
          const height = globeContainer.clientHeight;
          camera.aspect = width / height;
          camera.updateProjectionMatrix();
          renderer.setSize(width, height);
        });

      }, 1000);
    })
    .catch(err => console.error("❌ Excel 加载失败:", err));
  </script>
</body>
</html>
